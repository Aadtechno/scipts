pipeline {
    agent { label 'your-gcs-enabled-node' }

    environment {
        GCS_SOURCE_PATH = 'gs://northamerica/canada/internal/*/delete/'
        CUTOFF_DATE = '2025-03-31'
    }

    stages {
        stage('Filtered List Files from GCS') {
            steps {
                sh '''
                    echo "Filtering files modified on or before ${CUTOFF_DATE}, excluding *.yml"

                    # Convert cutoff date to epoch
                    cutoff_epoch=$(date -d "${CUTOFF_DATE}" +%s)

                    # List, filter, and print matching files
                    gsutil ls -l ${GCS_SOURCE_PATH}** | grep -v '^ *TOTAL:' | while read -r size timestamp filepath; do
                        [[ -z "$timestamp" || -z "$filepath" || "$filepath" == *.yml ]] && continue

                        file_epoch=$(date -d "$timestamp" +%s)

                        if [[ $file_epoch -le $cutoff_epoch ]]; then
                            echo "$size  $timestamp  $filepath"
                        fi
                    done
                '''
            }
        }
    }
}
