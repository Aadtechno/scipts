pipeline {
    agent any

    environment {
        SOURCE_FILE_GCS = "gs://your-bucket/source_file.txt" // GCS path of the source file list
        DESTINATION_BUCKET = "gs://test/" // Destination GCS bucket
    }

    stages {
        stage('Download and Display Source File') {
            steps {
                script {
                    sh '''
                    echo "Downloading source_file.txt from $SOURCE_FILE_GCS"
                    gcloud storage cp "$SOURCE_FILE_GCS" source_file.txt

                    # Verify the file was downloaded successfully
                    if [[ ! -f "source_file.txt" ]]; then
                        echo "Error: Failed to download $SOURCE_FILE_GCS"
                        exit 1
                    fi

                    echo "Contents of source_file.txt:"
                    cat source_file.txt
                    '''
                }
            }
        }

        stage('List Each Source File') {
            steps {
                script {
                    sh '''
                    echo "Listing and verifying files from source_file.txt"

                    # Iterate over each file path and list its details
                    for source_file in $(cat source_file.txt); do
                        if [[ -n "$source_file" ]]; then
                            echo "Listing $source_file"
                            gsutil ls -l "$source_file"

                            # Check if the file exists
                            if [[ $? -ne 0 ]]; then
                                echo "Error: $source_file does not exist or cannot be accessed"
                                exit 1
                            fi
                        fi
                    done

                    echo "All files verified successfully."
                    '''
                }
            }
        }

        stage('Copy Files to Destination') {
            steps {
                script {
                    sh '''
                    echo "Copying files to $DESTINATION_BUCKET"

                    # Read and copy each file to the destination
                    for source_file in $(cat source_file.txt); do
                        if [[ -n "$source_file" ]]; then
                            echo "Copying $source_file to $DESTINATION_BUCKET"
                            gsutil cp "$source_file" "$DESTINATION_BUCKET"

                            # Check if the copy was successful
                            if [[ $? -ne 0 ]]; then
                                echo "Error: Failed to copy $source_file"
                                exit 1
                            fi
                        fi
                    done

                    echo "All files copied successfully."
                    '''
                }
            }
        }

        stage('Verify Destination') {
            steps {
                script {
                    sh '''
                    echo "Verifying files in $DESTINATION_BUCKET"

                    # List all files in the destination bucket
                    gsutil ls -l "$DESTINATION_BUCKET"

                    # Display the total size of the files in the destination bucket
                    gsutil du -s "$DESTINATION_BUCKET"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed.'
        }
    }
}
