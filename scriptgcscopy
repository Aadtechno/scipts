pipeline {
    agent any

    environment {
        SOURCE_FILE_GCS = "gs://your-bucket/source_file.txt" // GCS path of the source file list
        DESTINATION_BUCKET = "gs://test/" // Destination GCS bucket
    }

    stages {
        stage('Download Source File') {
            steps {
                script {
                    // Download the source file list from GCS to the workspace
                    sh '''
                    echo "Downloading source file list from $SOURCE_FILE_GCS"
                    gcloud storage cp "$SOURCE_FILE_GCS" source_file.txt

                    # Verify the file was downloaded successfully
                    if [[ ! -f "source_file.txt" ]]; then
                        echo "Error: Failed to download $SOURCE_FILE_GCS"
                        exit 1
                    fi

                    echo "Source file list downloaded successfully."
                    '''
                }
            }
        }

        stage('Verify Source Files') {
            steps {
                script {
                    // Verify each file listed in source_file.txt
                    sh '''
                    echo "Verifying the files listed in source_file.txt"

                    # Read and verify each file
                    while IFS= read -r source_file; do
                        if [[ -n "$source_file" ]]; then
                            echo "Checking $source_file"
                            gcloud storage ls -l "$source_file"

                            # Check if the file exists
                            if [[ $? -ne 0 ]]; then
                                echo "Error: $source_file does not exist or cannot be accessed"
                                exit 1
                            fi
                        fi
                    done < source_file.txt

                    echo "All source files verified successfully."
                    '''
                }
            }
        }

        stage('Copy Files to Destination') {
            steps {
                script {
                    // Copy files to the destination bucket
                    sh '''
                    echo "Copying files to $DESTINATION_BUCKET"

                    # Read and copy each file
                    while IFS= read -r source_file; do
                        if [[ -n "$source_file" ]]; then
                            echo "Copying $source_file to $DESTINATION_BUCKET"
                            gcloud storage cp "$source_file" "$DESTINATION_BUCKET"

                            # Check if the copy was successful
                            if [[ $? -ne 0 ]]; then
                                echo "Error: Failed to copy $source_file"
                                exit 1
                            fi
                        fi
                    done < source_file.txt

                    echo "All files copied successfully to $DESTINATION_BUCKET."
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Job completed successfully!'
        }
        failure {
            echo 'Job failed!'
        }
    }
}
