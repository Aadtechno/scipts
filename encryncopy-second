pipeline {
    agent none

    stages {
        stage('Check File in NPE') {
            agent { label 'npe-agent-label' }
            steps {
                script {
                    def gcsPath = 'gs://your-npe-bucket-name/path/to/your/file.txt'
                    echo "Checking file in NPE bucket"
                    def fileExists = sh(script: "gsutil -q stat ${gcsPath}", returnStatus: true) == 0

                    if (fileExists) {
                        echo "File exists in NPE bucket"
                        build job: 'downstream-job-npe', wait: false
                    } else {
                        error "File does not exist in NPE bucket"
                    }
                }
            }
        }

        stage('Check File in UAT') {
            agent { label 'uat-agent-label' }
            steps {
                script {
                    def gcsPath = 'gs://your-uat-bucket-name/path/to/your/file.txt'
                    echo "Checking file in UAT bucket"
                    def fileExists = sh(script: "gsutil -q stat ${gcsPath}", returnStatus: true) == 0

                    if (fileExists) {
                        echo "File exists in UAT bucket"
                        build job: 'downstream-job-uat', wait: false
                    } else {
                        error "File does not exist in UAT bucket"
                    }
                }
            }
        }

        stage('Check File in PROD') {
            agent { label 'prod-agent-label' }
            steps {
                script {
                    def gcsPath = 'gs://your-prod-bucket-name/path/to/your/file.txt'
                    echo "Checking file in PROD bucket"
                    def fileExists = sh(script: "gsutil -q stat ${gcsPath}", returnStatus: true) == 0

                    if (fileExists) {
                        echo "File exists in PROD bucket"
                        build job: 'downstream-job-prod', wait: false
                    } else {
                        error "File does not exist in PROD bucket"
                    }
                }
            }
        }
    }
}
